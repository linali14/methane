<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit 5 Assignment: Methane Molecule (CH4) Model</title>
    <style>
        /* CSS adapted from your snippet for centering and look */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #f0f0f0; 
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas { 
            display: block; 
            outline: none;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            text-align: center;
            font-size: 14px;
            z-index: 10;
        }
        .controls strong { 
            color: #880000; 
        }
    </style>
    <!-- 
        FIXED IMPORTS: Switched to stable r128 CDN links for the core library and its examples 
        (FontLoader and TextGeometry) to ensure they are properly exposed on the THREE global object.
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/FontLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/geometries/TextGeometry.js"></script>
</head>
<body>
<div class="controls">
    <p>Methane Molecule ($\text{CH}_4$) - **Interactive 3D Model**</p>
    <p>Use **Click and Drag** or **Touch Swipe** to manually rotate the molecule.</p>
</div>

<!-- Main script tag -->
<script>
    // --- Global Setup ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    
    // Y_OFFSET: Value to lift the molecule up in the scene.
    const Y_OFFSET = 1.5; 

    // Enable shadows in the renderer
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true; 
    renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
    document.body.appendChild(renderer.domElement);

    // Camera Positioning: Adjusted lookAt target to view both the high molecule and the low ground plane.
    camera.position.set(0, 3, 5);
    camera.lookAt(0, 0.75, 0); // Camera now looks slightly below the lifted molecule center

    // --- Colors and Dimensions ---
    const CARBON_COLOR = 0xcc0000;      // Red tone for Carbon
    const HYDROGEN_COLOR = 0x0040ff;    // Blue tone for Hydrogen
    const BOND_COLOR = 0xffffff;        // White for bonds
    const BOND_EMISSIVE = 0x333333;     // Light gray emissive for bonds
    const PLANE_COLOR = 0x00aa00;       // Green color for the plane

    const RADIUS_C = 0.6;               // Carbon atom radius
    const RADIUS_H = 0.3;               // Hydrogen atom radius
    const BOND_LENGTH = 2.0;            // Distance from center C to center H
    const BOND_THICKNESS = 0.1;
    // Calculated Y position of the plane's surface relative to the molecule's origin (0, 0, 0)
    const PLANE_Y_POSITION = -RADIUS_C - 0.1; 

    // --- Lighting ---
    const ambientLight = new THREE.AmbientLight(0x404040, 1.5); 
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 2.0);
    directionalLight.position.set(10, 15, 10);
    directionalLight.castShadow = true; 
    directionalLight.shadow.mapSize.width = 1024;
    directionalLight.shadow.mapSize.height = 1024;
    scene.add(directionalLight);

    // --- Methane Molecule (CH4) Assembly ---
    const methaneGroup = new THREE.Group();
    methaneGroup.position.y = Y_OFFSET; // Molecule remains lifted at Y=1.5
    
    // 1. Carbon Atom (Center)
    const c_geometry = new THREE.SphereGeometry(RADIUS_C, 32, 32);
    const c_material = new THREE.MeshPhongMaterial({ color: CARBON_COLOR, shininess: 50 });
    const carbon = new THREE.Mesh(c_geometry, c_material);
    carbon.position.set(0, 0, 0);
    carbon.castShadow = true; 
    methaneGroup.add(carbon);

    // 2. Tetrahedral Positions for Hydrogen Atoms
    const H_positions = [
        new THREE.Vector3(1, 1, 1).normalize().multiplyScalar(BOND_LENGTH),
        new THREE.Vector3(-1, -1, 1).normalize().multiplyScalar(BOND_LENGTH),
        new THREE.Vector3(-1, 1, -1).normalize().multiplyScalar(BOND_LENGTH),
        new THREE.Vector3(1, -1, -1).normalize().multiplyScalar(BOND_LENGTH)
    ];

    const h_geometry = new THREE.SphereGeometry(RADIUS_H, 32, 32);
    const h_material = new THREE.MeshPhongMaterial({ color: HYDROGEN_COLOR, shininess: 50 });
    const bond_material = new THREE.MeshPhongMaterial({ 
        color: BOND_COLOR, 
        emissive: BOND_EMISSIVE, 
        emissiveIntensity: 0.5,
        shininess: 100
    });
    
    // 3. Create 4 Hydrogen Atoms and 4 Bonds
    H_positions.forEach(pos => {
        // --- Hydrogen Atom ---
        const hydrogen = new THREE.Mesh(h_geometry, h_material);
        hydrogen.position.copy(pos);
        hydrogen.castShadow = true;
        methaneGroup.add(hydrogen);

        // --- Bond (Cylinder) ---
        
        // Calculate the length of the cylinder that fits perfectly between the two atoms' surfaces.
        const bond_cylinder_length = pos.length() - RADIUS_C - RADIUS_H;
        const bond_geometry = new THREE.CylinderGeometry(BOND_THICKNESS, BOND_THICKNESS, bond_cylinder_length, 8);
        const bond = new THREE.Mesh(bond_geometry, bond_material);
        bond.castShadow = true;
        
        // Calculate the direction vector from Carbon to Hydrogen
        const C_to_H_direction = new THREE.Vector3().copy(pos).normalize();
        
        // Position the bond at the midpoint between the two sphere surfaces
        const startPoint = C_to_H_direction.clone().multiplyScalar(RADIUS_C);
        const endPoint = pos.clone().sub(C_to_H_direction.clone().multiplyScalar(RADIUS_H));
        
        bond.position.addVectors(startPoint, endPoint).divideScalar(2);
        
        // Orient the bond
        const axis = new THREE.Vector3(0, 1, 0); 
        const quaternion = new THREE.Quaternion();
        quaternion.setFromUnitVectors(axis, C_to_H_direction); 
        bond.setRotationFromQuaternion(quaternion);

        methaneGroup.add(bond);
    });

    scene.add(methaneGroup);

    // --- Green Plane (Ground) ---
    // The molecule is now "deconnected" by placing the plane lower.
    const plane_geometry = new THREE.PlaneGeometry(15, 15);
    const plane_material = new THREE.MeshPhongMaterial({ color: PLANE_COLOR, side: THREE.DoubleSide });
    const plane = new THREE.Mesh(plane_geometry, plane_material);
    plane.rotation.x = -Math.PI / 2; 
    plane.position.y = PLANE_Y_POSITION; // PLANE is now positioned at Y=-0.7 (below the visual focus)
    plane.receiveShadow = true; 
    plane.castShadow = false;
    scene.add(plane);

    // --- Interactivity State and Handlers (Mouse/Touch Controls) ---

    let isDragging = false;
    let previousMousePosition = { x: 0, y: 0 };
    const rotationSpeed = 0.01;

    // Mouse Controls
    renderer.domElement.addEventListener('mousedown', (e) => {
        isDragging = true;
        previousMousePosition.x = e.clientX;
        previousMousePosition.y = e.clientY;
    });

    renderer.domElement.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaX = e.clientX - previousMousePosition.x;
        const deltaY = e.clientY - previousMousePosition.y;

        methaneGroup.rotation.y += deltaX * rotationSpeed;
        methaneGroup.rotation.x += deltaY * rotationSpeed;
        
        previousMousePosition.x = e.clientX;
        previousMousePosition.y = e.clientY;
    });

    renderer.domElement.addEventListener('mouseup', () => {
        isDragging = false;
    });
    
    // Touch Controls
    renderer.domElement.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDragging = true;
        const touch = e.touches[0];
        previousMousePosition.x = touch.clientX;
        previousMousePosition.y = touch.clientY;
    });

    renderer.domElement.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDragging) return;
        const touch = e.touches[0];
        
        const deltaX = touch.clientX - previousMousePosition.x;
        const deltaY = touch.clientY - previousMousePosition.y;

        methaneGroup.rotation.y += deltaX * rotationSpeed * 1.5;
        methaneGroup.rotation.x += deltaY * rotationSpeed * 1.5;
        
        previousMousePosition.x = touch.clientX;
        previousMousePosition.y = touch.clientY;
    });

    renderer.domElement.addEventListener('touchend', () => {
        isDragging = false;
    });
    
    // --- 3D TEXT LABEL ($\text{CH}_4$) AND ANIMATION START ---
    
    // This code ensures the FontLoader class is fully available before instantiation.
    window.onload = function() {
        // Check if FontLoader is available 
        if (typeof THREE.FontLoader === 'undefined') {
            console.error("THREE.FontLoader is still not defined. Text label cannot be created.");
            animate(); 
            return;
        }

        const loader = new THREE.FontLoader(); 
        
        // Load font asynchronously
        loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function (font) {
            
            const textOptions = {
                font: font,
                size: 0.8,
                height: 0.1, 
                curveSegments: 12
            };
            
            const textMaterial = new THREE.MeshPhongMaterial({ color: 0x444444, shininess: 30 });

            // 3D Text for "CH"
            const chGeometry = new THREE.TextGeometry('CH', textOptions); 
            chGeometry.computeBoundingBox();
            const ch = new THREE.Mesh(chGeometry, textMaterial);
            ch.castShadow = true;
            
            // 3D Text for subscript "4"
            const sub4Options = { ...textOptions, size: 0.4, height: 0.05 }; 
            const sub4Geometry = new THREE.TextGeometry('4', sub4Options); 
            sub4Geometry.computeBoundingBox();
            const sub4 = new THREE.Mesh(sub4Geometry, textMaterial);
            sub4.castShadow = true;

            // Position subscript '4' relative to 'CH'
            const chWidth = chGeometry.boundingBox.max.x - chGeometry.boundingBox.min.x;
            sub4.position.x = chWidth - 0.1; 
            sub4.position.y = -0.3; 
            
            // Group and position the label
            const labelGroup = new THREE.Group();
            labelGroup.add(ch);
            labelGroup.add(sub4);
            
            // Center the label horizontally
            const labelWidth = chWidth + (sub4Options.size / 2);
            labelGroup.position.x = -labelWidth / 2 + 0.1; 
            
            // Label Y position is relative to the molecule center (Y_OFFSET)
            labelGroup.position.y = -0.6; 
            
            labelGroup.rotation.x = -Math.PI * 0.1; 
            
            methaneGroup.add(labelGroup);
        });

        // Start the animation loop after everything is initialized
        animate(); 
    }

    // --- Animation Loop ---
    function animate() {
        requestAnimationFrame(animate);

        // Auto-rotation when not being manually dragged
        if (!isDragging) {
            methaneGroup.rotation.y += 0.005; 
        }
        
        renderer.render(scene, camera);
    }

    // --- Window Resize Handler ---
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

</script>
</body>
</html>
