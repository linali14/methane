// ** Three.js Initialization **

// Standard Setup
let scene, camera, renderer, controls, methaneGroup;

function init() {
    // 1. Scene Setup
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000); // Black background for realism

    // 2. Camera Setup
    // FOV, Aspect Ratio, Near Clipping, Far Clipping
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5; // Move camera back to see the object

    // 3. Renderer Setup
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true; // IMPORTANT: Enable shadow mapping
    renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Softer shadows
    document.body.appendChild(renderer.domElement);

    // 4. Orbit Controls (Mouse Controls)
    // This allows the user to rotate the camera around the scene center (0,0,0)
    // which effectively rotates the molecule since it is centered there.
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; // Smoother controls
    controls.dampingFactor = 0.05;

    // 5. Create the Methane Molecule and Ground
    methaneGroup = new THREE.Group(); // All molecule components go into this group
    scene.add(methaneGroup);
    
    createMethaneMolecule();
    createGroundPlane();
    setupLighting();
    
    // Handle window resizing
    window.addEventListener('resize', onWindowResize, false);
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

// ** Methane Molecule Construction **

function createMethaneMolecule() {
    // Define sizes and C-H bond length (L)
    const carbonRadius = 0.5;
    const hydrogenRadius = 0.3;
    const bondRadius = 0.08;
    const L = 1.5; // C-H bond length (distance from center to H atom)

    // --- 5.1. Carbon Atom (Center) ---
    const carbonGeometry = new THREE.SphereGeometry(carbonRadius, 32, 32);
    // Use Lambert material for diffuse reflection
    const carbonMaterial = new THREE.MeshLambertMaterial({ color: 0xaa0000 }); // Red tone
    const carbon = new THREE.Mesh(carbonGeometry, carbonMaterial);
    carbon.castShadow = true; // Carbon atom casts shadow
    methaneGroup.add(carbon);

    // --- 5.2. Hydrogen Atoms and Bonds (Tetrahedral Positioning) ---
    // The four vertices of a tetrahedron that are equidistant from the origin.
    // Coordinates are normalized for cleaner bond length L.
    const H_positions = [
        new THREE.Vector3(L, L, L).normalize().multiplyScalar(L),
        new THREE.Vector3(-L, -L, L).normalize().multiplyScalar(L),
        new THREE.Vector3(-L, L, -L).normalize().multiplyScalar(L),
        new THREE.Vector3(L, -L, -L).normalize().multiplyScalar(L)
    ];

    const hydrogenMaterial = new THREE.MeshLambertMaterial({ color: 0x0000ff }); // Blue tone
    const bondMaterial = new THREE.MeshPhongMaterial({ 
        color: 0xffffff, // White diffuse
        emissive: 0x444444 // Light gray emissive component
    });

    // Iterate through the four tetrahedral positions
    H_positions.forEach(position => {
        // Create Hydrogen Atom
        const hydrogen = new THREE.Mesh(
            new THREE.SphereGeometry(hydrogenRadius, 32, 32), 
            hydrogenMaterial
        );
        hydrogen.position.copy(position); // Set position
        hydrogen.castShadow = true;
        methaneGroup.add(hydrogen);

        // Create Bond (Cylinder)
        const bond = createCylinderBond(
            new THREE.Vector3(0, 0, 0), // Start at Carbon center
            position, // End at Hydrogen center
            bondRadius,
            bondMaterial
        );
        bond.castShadow = true;
        methaneGroup.add(bond);
    });
}

/**
 * Creates a cylinder mesh positioned and rotated to connect two points.
 * @param {THREE.Vector3} point1 - Start point (Carbon center)
 * @param {THREE.Vector3} point2 - End point (Hydrogen center)
 * @param {number} radius - Radius of the cylinder
 * @param {THREE.Material} material - Cylinder material
 * @returns {THREE.Mesh} The cylinder mesh
 */
function createCylinderBond(point1, point2, radius, material) {
    // 1. Calculate the distance (length) and midpoint of the cylinder
    const direction = new THREE.Vector3().subVectors(point2, point1);
    const length = direction.length();
    const midpoint = new THREE.Vector3().addVectors(point1, point2).divideScalar(2);

    // 2. Create the cylinder geometry
    const bondGeometry = new THREE.CylinderGeometry(radius, radius, length, 8);
    const bond = new THREE.Mesh(bondGeometry, material);

    // 3. Set position to the midpoint
    bond.position.copy(midpoint);

    // 4. Set rotation to align the cylinder's height (Y-axis) with the direction vector
    bond.quaternion.setFromUnitVectors(
        new THREE.Vector3(0, 1, 0), // Default cylinder axis
        direction.normalize() // Target axis
    );
    
    // The cylinder is now aligned perpendicular to the sphere's surface and centered
    return bond;
}

// ** Ground Plane **

function createGroundPlane() {
    // Dimensions and Material
    const planeSize = 10;
    const planeGeometry = new THREE.PlaneGeometry(planeSize, planeSize);
    // Green colored plane object
    const planeMaterial = new THREE.MeshLambertMaterial({ color: 0x006400 }); // Dark green
    const plane = new THREE.Mesh(planeGeometry, planeMaterial);

    // Position the plane below the molecule
    plane.rotation.x = -Math.PI / 2; // Rotate to lie flat (XZ plane)
    plane.position.y = -2; // Below the molecule
    plane.receiveShadow = true; // IMPORTANT: Plane receives shadows
    
    // Ensure only the molecule moves, not the plane
    // The plane is added directly to the scene, not the rotation group (methaneGroup).
    scene.add(plane);
}

// ** Lighting Setup **

function setupLighting() {
    // Ambient Light: Soft, overall illumination
    const ambientLight = new THREE.AmbientLight(0x404040, 3); // Soft white light
    scene.add(ambientLight);

    // Directional Light: For sharp shadows and primary lighting
    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
    directionalLight.position.set(5, 10, 7.5); // Position above and to the side
    directionalLight.castShadow = true; // Light casts shadows

    // Configure shadow map properties for better shadows
    directionalLight.shadow.mapSize.width = 1024;
    directionalLight.shadow.mapSize.height = 1024;
    // Set frustum bounds for the shadow camera
    const d = 5;
    directionalLight.shadow.camera.left = -d;
    directionalLight.shadow.camera.right = d;
    directionalLight.shadow.camera.top = d;
    directionalLight.shadow.camera.bottom = -d;
    directionalLight.shadow.camera.near = 0.1;
    directionalLight.shadow.camera.far = 50;

    scene.add(directionalLight);
    
    // Optional: Helper to visualize the light's shadow camera frustum
    // const helper = new THREE.CameraHelper(directionalLight.shadow.camera);
    // scene.add(helper);
}

// ** Animation Loop **

function animate() {
    requestAnimationFrame(animate);

    // 1. Continuous Animation
    // Apply a small, continuous rotation to the entire methane molecule group
    // The plane remains stationary because it's not in this group.
    methaneGroup.rotation.x += 0.005;
    methaneGroup.rotation.y += 0.005;

    // 2. Mouse Controls (Handled by OrbitControls)
    controls.update(); // Must be called if controls.enableDamping or controls.autoRotate are set

    // Render the scene
    renderer.render(scene, camera);
}

// ** Run the Program **
init();
animate();
